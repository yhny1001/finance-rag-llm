# 金融监管制度智能问答系统 - 快速启动指南

## 🚀 快速开始

### 步骤 1: 验证项目设置

首先运行测试脚本检查项目配置：

```bash
python test_setup.py
```

### 步骤 2: 安装依赖

在ModelScope服务器环境中安装所需依赖：

```bash
pip install -r requirements.txt
```

如果遇到网络问题，可以使用镜像源：

```bash
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple/
```

### 步骤 3: 验证环境

再次运行测试脚本确认环境配置正确：

```bash
python test_setup.py
```

### 🆕 步骤 4: 构建向量数据库（一次性操作）

⭐ **新增功能**：首次使用需要构建向量数据库，后续启动将秒级完成。

```bash
# 方式一：使用专用管理工具（推荐）
python vector_db_manager.py --build

# 方式二：通过主程序构建
python main.py --force-rebuild --end-idx 5  # 构建时先测试少量数据
```

### 步骤 5: 运行系统

#### 选项A: 完整批量测试（推荐）

```bash
# 运行完整测试（向量数据库已构建，启动很快）
python main.py

# 小批量测试
python main.py --batch-size 5 --start-idx 0 --end-idx 10
```

#### 选项B: 交互式问答

```bash
python main.py --interactive
```

## 🗄️ 向量数据库管理

### 查看数据库状态

```bash
# 查看向量数据库详细信息
python vector_db_manager.py --status

# 在主程序中查看信息
python main.py --vector-info
```

### 重建数据库

```bash
# 使用管理工具重建
python vector_db_manager.py --force-rebuild

# 通过主程序重建
python main.py --rebuild-vector
```

### 测试搜索功能

```bash
# 搜索特定内容
python vector_db_manager.py --search "银行资本充足率" --top-k 5

# 进入交互式搜索模式
python vector_db_manager.py --test-search
```

### 清空数据库

```bash
python vector_db_manager.py --clear
```

## 📋 完整使用流程指南

### 🎯 首次使用流程（完整部署）

#### 第一步：环境准备
```bash
# 1. 检查Python环境和项目文件
python test_setup.py

# 2. 安装所有依赖包
pip install -r requirements.txt

# 3. 验证FAISS向量数据库功能
python demo_vector_db.py
```

#### 第二步：构建向量数据库
```bash
# 4. 查看当前向量数据库状态
python vector_db_manager.py --status

# 5. 构建生产向量数据库（重要：这是一次性操作）
python vector_db_manager.py --build

# 6. 验证构建结果
python vector_db_manager.py --status
```

#### 第三步：系统验证
```bash
# 7. 测试向量数据库搜索功能
python vector_db_manager.py --search "银行风险管理制度" --top-k 3

# 8. 运行小批量测试验证系统
python main.py --batch-size 3 --end-idx 5

# 9. 测试交互式问答
python main.py --interactive
```

#### 第四步：生产运行
```bash
# 10. 运行完整测试（所有问题）
python main.py

# 或指定范围运行
python main.py --start-idx 0 --end-idx 100 --batch-size 10
```

### ⚡ 日常使用流程（快速启动）

日常使用时，向量数据库已构建完成，系统启动非常快速：

#### 标准批量处理
```bash
# 直接运行（5-10秒内启动）
python main.py

# 处理特定范围的问题
python main.py --start-idx 100 --end-idx 200 --batch-size 15

# 大批量处理（适合显存充足的环境）
python main.py --batch-size 20
```

#### 交互式问答模式
```bash
# 进入交互式模式
python main.py --interactive

# 在交互模式中可以使用的命令：
# - 直接输入问题：获得实时答案
# - 输入 'info'：查看向量数据库统计信息
# - 输入 'quit'：退出系统
```

#### 系统监控和信息查询
```bash
# 查看系统状态
python main.py --vector-info

# 查看详细的向量数据库信息
python vector_db_manager.py --status

# 检查最新的输出结果
ls -la output/  # 查看生成的结果文件
```

### 🛠️ 向量数据库管理功能

#### 状态查询和监控
```bash
# 查看向量数据库完整状态
python vector_db_manager.py --status
# 显示：文件存在性、向量数量、索引类型、创建时间等

# 在主程序中快速查看
python main.py --vector-info
# 显示：基本统计信息和存储路径
```

#### 搜索功能测试
```bash
# 单次搜索测试
python vector_db_manager.py --search "商业银行资本充足率" --top-k 5

# 批量搜索测试
python vector_db_manager.py --search "反洗钱制度" --top-k 3
python vector_db_manager.py --search "风险管理体系" --top-k 10

# 交互式搜索模式（推荐用于调试）
python vector_db_manager.py --test-search
# 可以连续输入多个查询，实时查看检索效果
```

#### 数据库维护操作
```bash
# 重建向量数据库（当文档更新时）
python vector_db_manager.py --force-rebuild

# 通过主程序重建
python main.py --rebuild-vector

# 清空向量数据库（谨慎操作）
python vector_db_manager.py --clear
# 注意：这将删除所有向量数据，需要重新构建
```

#### 性能优化检查
```bash
# 检查向量数据库性能
python vector_db_manager.py --test-search
# 观察搜索响应时间，正常应该在0.01-0.1秒内

# 监控文件大小（用于容量规划）
python -c "
import os
from pathlib import Path
vdb_path = Path('vector_db')
if vdb_path.exists():
    for file in vdb_path.iterdir():
        size = file.stat().st_size
        print(f'{file.name}: {size/1024/1024:.2f} MB')
"
```

## 🔧 常见参数

### 主程序参数

```bash
python main.py [参数]

--force-rebuild     # 强制重建向量数据库
--batch-size N      # 设置批处理大小（默认10）
--start-idx N       # 设置开始处理的问题索引
--end-idx N         # 设置结束处理的问题索引
--interactive       # 进入交互式问答模式
--vector-info       # 显示向量数据库信息 ⭐ 新增
--rebuild-vector    # 重建向量数据库 ⭐ 新增
```

### 向量数据库管理参数

```bash
python vector_db_manager.py [参数]

--status            # 显示向量数据库状态
--build             # 构建向量数据库
--force-rebuild     # 强制重建向量数据库
--search TEXT       # 搜索文档
--top-k N           # 搜索返回数量
--test-search       # 测试搜索功能
--clear             # 清空向量数据库
```

### 实用命令组合示例

```bash
# 首次使用完整流程
python test_setup.py && \
python vector_db_manager.py --build && \
python main.py --batch-size 5 --end-idx 20

# 日常使用（快速启动）
python main.py

# 更新文档后重建并测试
python vector_db_manager.py --force-rebuild && \
python main.py --batch-size 3 --end-idx 10

# 性能测试流程
python vector_db_manager.py --status && \
python vector_db_manager.py --search "银行监管" --top-k 5 && \
python main.py --interactive

# 故障排除流程
python test_setup.py && \
python vector_db_manager.py --status && \
python main.py --vector-info
```

## 📂 输出文件

系统会在 `output/` 目录生成以下文件：

- `results_YYYYMMDD_HHMMSS.json` - 完整结果（JSON格式）
- `results_YYYYMMDD_HHMMSS.csv` - 完整结果（CSV格式）
- `batch_results_X_Y_YYYYMMDD_HHMMSS.json` - 批次中间结果

向量数据库文件存储在 `vector_db/` 目录：

- `faiss_index.bin` - FAISS向量索引
- `vector_metadata.json` - 向量数据库元数据
- `document_store.json` - 文档内容存储

## 🎯 测试数据格式

系统支持的问题格式：

### 选择题
```json
{
  "id": 12,
  "category": "选择题",
  "question": "城商行内审部门负责人任职后需在多少日内备案？",
  "content": "A. 3个工作日\nB. 5个工作日\nC. 10个工作日\nD. 30个工作日"
}
```

### 问答题
```json
{
  "id": 13,
  "category": "问答题",
  "question": "简述商业银行资本充足率的最低监管要求指标及各自数值。",
  "content": null
}
```

## ⚡ 性能优势对比

### 传统方式（无向量数据库持久化）
- **每次启动**：需要重新加载文档、切片、向量化（5-10分钟）
- **内存占用**：重复计算，效率低

### 🆕 向量数据库持久化方式
- **首次构建**：5-10分钟（一次性）
- **后续启动**：5-10秒（直接加载预计算向量）
- **内存效率**：FAISS优化索引，检索速度快

## 🛠️ 性能调优建议

### 如果向量数据库构建慢：
```bash
# 在config.py中调整参数：
BATCH_ENCODE_SIZE = 16        # 减小批量编码大小
CHUNK_SIZE = 256              # 减小文档切片大小
```

### 如果显存不足：
```bash
# 减小批处理大小
python main.py --batch-size 3

# 或者在config.py中调整：
GPU_MEMORY_FRACTION = 0.6     # 减少GPU显存使用
```

### 如果检索速度慢：
```bash
# 在config.py中选择更快的索引类型：
FAISS_INDEX_TYPE = "IndexFlatIP"    # 精度高，速度中等
FAISS_INDEX_TYPE = "IndexIVFFlat"   # 大规模数据，速度快
```

## 🐛 故障排除

### 问题1: 向量数据库损坏
```
错误: 无法加载向量数据库
```
**解决方案**: 
```bash
python vector_db_manager.py --status  # 检查状态
python vector_db_manager.py --force-rebuild  # 重建数据库
```

### 问题2: 模型路径不存在
```
错误: 路径不存在 - /mnt/workspace/.cache/modelscope/models/...
```
**解决方案**: 检查模型是否已下载到正确位置，或修改 `config.py` 中的路径。

### 问题3: 显存不足
```
错误: RuntimeError: CUDA out of memory
```
**解决方案**: 
- 减小 `--batch-size` 参数
- 在 `config.py` 中减小 `BATCH_ENCODE_SIZE` 和 `CHUNK_SIZE`

### 问题4: 文档加载失败
```
错误: 文档目录不存在
```
**解决方案**: 确保 `赛题制度文档/` 目录存在并包含文档文件。

### 问题5: 依赖模块未安装
```
错误: No module named 'faiss'
```
**解决方案**: 运行 `pip install -r requirements.txt`

## 📊 结果分析

系统会自动生成统计信息：
- 总问题数
- 选择题/问答题数量
- 处理成功率
- 平均检索源数量
- **向量数据库统计信息** ⭐ 新增

查看详细结果：
- JSON文件：包含完整答案和上下文
- CSV文件：便于Excel查看和分析

## 🔍 高级功能

### 向量数据库查询
```bash
# 搜索相关文档
python vector_db_manager.py --search "银行风险管理" --top-k 3

# 交互式搜索测试
python vector_db_manager.py --test-search
```

### 系统信息查看
```bash
# 查看向量数据库详细信息
python main.py --vector-info

# 在交互模式中输入 'info'
python main.py --interactive
# 然后输入: info
```

## 📞 技术支持

如果遇到问题：
1. 首先运行 `python test_setup.py` 检查环境
2. 使用 `python vector_db_manager.py --status` 检查向量数据库状态
3. 查看错误日志和堆栈信息
4. 检查 `config.py` 中的路径配置
5. 确认模型文件已正确下载

## 🎉 开始使用

现在您可以开始使用金融监管制度智能问答系统了！

### 完整的第一次使用流程：

```bash
# 1. 环境检查
python test_setup.py

# 2. 安装依赖
pip install -r requirements.txt

# 3. 构建向量数据库（一次性）
python vector_db_manager.py --build

# 4. 快速测试
python main.py --batch-size 5 --end-idx 5

# 5. 交互式体验
python main.py --interactive
```

### 日常使用：

```bash
# 直接运行（秒级启动）
python main.py

# 或者交互式问答
python main.py --interactive
```

祝您使用愉快！🚀 