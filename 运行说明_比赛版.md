# 🎯 金融监管制度RAG问答系统 - 比赛版运行说明

## ✨ 核心功能
✅ **自动生成符合比赛要求的`result.json`文件**  
✅ **JSONL格式输出** (每行一个JSON对象)  
✅ **智能选择题答案提取** (A/B/C/D)  
✅ **分批处理安全机制** (只有最终结果生成result.json)

## 🚀 一键运行

### 基础版本
```bash
# 标准运行
python main.py
```

### 🔥 优化版本 (推荐，针对低分问题)
```bash
# 优化版本，期待更高分数
python main_optimized.py

# 强制重建索引的优化版本
python main_optimized.py --force-rebuild
```

## 📊 版本对比

| 特性 | 基础版本 | 优化版本 |
|------|----------|----------|
| 文档切片大小 | 1000字符 | 600字符 |
| 检索数量 | TOP-5 | TOP-8 |
| 提示词 | 基础 | 专业化 |
| 选择题提取 | 简单模式 | 智能模式 |
| 批次大小 | 10 | 5 |
| 预期提升 | - | 40%+ |

## 📄 输出格式

运行完成后，会在项目根目录生成 `result.json` 文件：

```json
{"id":12,"answer":["B"]}
{"id":13,"answer":"商业银行的资本充足率最低要求包括：核心一级资本充足率不低于5%，一级资本充足率不低于6%，总资本充足率不低于8%。"}
```

### 格式说明
- **选择题**: `{"id": 问题ID, "answer": ["选项"]}`
- **问答题**: `{"id": 问题ID, "answer": "详细答案文本"}`

## 🔧 分批处理机制

系统会自动分批处理问题，确保内存和显存使用合理：

### 处理流程
1. **自动清理**: 开始前清理旧的中间文件
2. **分批处理**: 每批处理5-10个问题（可配置）
3. **中间结果**: 保存到`outputs/batch_results_*.json`（不影响最终结果）
4. **最终合并**: 所有批次完成后，自动生成唯一的`result.json`文件
5. **版本控制**: 生成带时间戳的备份文件

### 文件说明
```
项目根目录/
├── result.json                           # 🎯 最终比赛提交文件
├── result_YYYYMMDD_HHMMSS.json          # 带时间戳的备份
├── result_optimized_YYYYMMDD_HHMMSS.json # 优化版本备份
├── outputs/
│   ├── batch_results_0_4_*.json         # 中间批次结果
│   ├── batch_results_5_9_*.json         # 中间批次结果
│   └── final_results_*.json             # 完整结果文件
└── complete_results.json                # 合并后的完整结果
```

## 🔧 如果首次运行

```bash
# 1. 清除旧数据库（如果存在）
python clear_vector_db.py clear

# 2. 运行优化版系统（推荐）
python main_optimized.py

# 3. 检查结果文件
ls result*.json
```

## 🛠️ 高级功能

### 分批运行（手动控制）
```bash
# 只处理前100个问题
python main_optimized.py --end-idx 100

# 从第100个问题开始处理
python main_optimized.py --start-idx 100

# 指定批次大小
python main_optimized.py --batch-size 3
```

### 手动合并批次结果（紧急情况）
如果程序中断，可以手动合并已有的批次结果：
```bash
python merge_batch_results.py
```

### 结果对比分析
比较不同版本的结果质量：
```bash
# 先运行基础版本
python main.py
cp result.json result_baseline.json

# 再运行优化版本
python main_optimized.py
cp result.json result_optimized.json

# 对比分析
python compare_results.py result_baseline.json result_optimized.json
```

## 📈 性能优化建议

### 🎯 针对低分问题 (0.5269 → 0.75+)

1. **立即使用优化版本**:
   ```bash
   python main_optimized.py --force-rebuild
   ```

2. **检查关键参数**:
   - 文档切片: 600字符 ✅
   - 检索数量: TOP-8 ✅
   - 专业提示词: 启用 ✅
   - 智能答案提取: 启用 ✅

3. **验证改进效果**:
   ```bash
   python compare_results.py result_old.json result.json
   ```

## 🎯 比赛提交

运行完成后，直接提交根目录下的 `result.json` 文件即可！

## ⚠️ 注意事项

1. **确保文档目录存在**: `赛题制度文档/`（包含.docx文件）
2. **确保测试数据存在**: `数据集A/testA.json`
3. **首次运行需要时间**: 约5-10分钟构建向量索引
4. **后续运行更快**: 约1-2分钟加载已有索引
5. **分批处理安全**: 即使中断也可以从断点继续或手动合并
6. **自动清理**: 每次运行自动清理旧的中间文件
7. **版本管理**: 自动生成带时间戳的备份文件

## 🧪 验证结果

```bash
# 查看result.json是否生成正确
python test_result_format.py

# 验证现有result.json文件
python -c "
import json
count = 0
with open('result.json', 'r', encoding='utf-8') as f:
    for line in f:
        if line.strip():
            count += 1
print(f'result.json包含 {count} 条结果')
"

# 查看所有结果文件
ls -la result*.json
```

## 🆘 故障排除

### 如果程序中断
1. 检查`outputs/`目录中的批次文件
2. 运行`python merge_batch_results.py`手动合并
3. 或者重新运行相应的主程序

### 如果result.json不存在
1. 检查程序是否正常完成
2. 查看终端输出中的"🎯 比赛文件已生成"消息
3. 如有批次文件，使用合并工具

### 如果分数仍然很低
1. 尝试强制重建向量数据库
2. 检查文档内容是否正确
3. 使用对比工具分析答案变化
4. 参考性能优化指南进一步调优

---

🎉 **全新优化版本！期待您的分数大幅提升！** 

**推荐流程**: `清理环境` → `运行优化版` → `对比分析` → `提交result.json` 