"""
é€‰æ‹©é¢˜ç­”æ¡ˆæå–åŠŸèƒ½çš„ä¸“é—¨æµ‹è¯•è„šæœ¬
ä¸»è¦é’ˆå¯¹ä¸å®šé¡¹é€‰æ‹©é¢˜çš„ç­”æ¡ˆæå–
"""

import sys
import json
from pathlib import Path
from typing import List

# æ·»åŠ å½“å‰ç›®å½•åˆ°è·¯å¾„
sys.path.append(".")

# å¯¼å…¥ç­”æ¡ˆæå–å‡½æ•°
from main import FinancialQASystem

def test_extract_choice():
    """æµ‹è¯•é€‰æ‹©é¢˜ç­”æ¡ˆæå–"""
    
    qa_system = FinancialQASystem()
    
    test_cases = [
        # å•é€‰æµ‹è¯•ç”¨ä¾‹
        ("ç­”æ¡ˆæ˜¯A", ["A"], "åŸºæœ¬å•é€‰"),
        ("æ­£ç¡®ç­”æ¡ˆä¸ºB", ["B"], "åŸºæœ¬å•é€‰"),
        ("åº”è¯¥é€‰æ‹©C", ["C"], "åŸºæœ¬å•é€‰"),
        
        # å¤šé€‰æµ‹è¯•ç”¨ä¾‹ - æ ‡å‡†æ ¼å¼
        ("ç­”æ¡ˆæ˜¯A,B", ["A", "B"], "æ ‡å‡†å¤šé€‰"),
        ("æ­£ç¡®ç­”æ¡ˆä¸ºAã€Bã€C", ["A", "B", "C"], "æ ‡å‡†å¤šé€‰"),
        ("åº”è¯¥é€‰æ‹©Aï¼ŒC", ["A", "C"], "æ ‡å‡†å¤šé€‰"),
        
        # å¤šé€‰æµ‹è¯•ç”¨ä¾‹ - ç‰¹æ®Šæ ¼å¼
        ("é€‰é¡¹Aå’ŒDæ˜¯æ­£ç¡®çš„", ["A", "D"], "è¿æ¥è¯å’Œ"),
        ("A,B,Céƒ½æ˜¯æ­£ç¡®é€‰é¡¹", ["A", "B", "C"], "éƒ½æ˜¯æ¨¡å¼"),
        ("Aã€Cã€Dæ­£ç¡®", ["A", "C", "D"], "æ ‡å‡†å¤šé€‰"),
        ("ç­”æ¡ˆä¸ºï¼šA,B", ["A", "B"], "å†’å·å¤šé€‰"),
        
        # é¢å¤–è¾¹ç•Œæƒ…å†µæµ‹è¯•
        ("é€‰é¡¹Bä¸Cæ˜¯æ­£ç¡®ç­”æ¡ˆ", ["B", "C"], "è¿æ¥è¯ä¸"),
        ("æ—¢æœ‰Aä¹Ÿæœ‰Bæ˜¯å¯¹çš„", ["A", "B"], "ä¹Ÿæœ‰æ¨¡å¼"),
        ("æœ¬é¢˜ç­”æ¡ˆåŒ…æ‹¬Aä»¥åŠC", ["A", "C"], "åŒ…æ‹¬ä»¥åŠ"),
    ]
    
    total = len(test_cases)
    passed = 0
    
    print(f"å¼€å§‹æµ‹è¯• {total} ä¸ªé€‰æ‹©é¢˜ç­”æ¡ˆæå–ç”¨ä¾‹")
    print("="*50)
    
    for i, (input_text, expected, test_type) in enumerate(test_cases, 1):
        print(f"\næµ‹è¯• {i}/{total} [{test_type}]:")
        print(f"  è¾“å…¥: {input_text}")
        print(f"  æœŸæœ›: {expected}")
        
        result = qa_system.extract_choice_answer(input_text)
        
        # å¯¹äºå¤šé€‰é¢˜ï¼Œæ’åºåå†æ¯”è¾ƒ
        if len(expected) > 1:
            expected = sorted(expected)
            result = sorted(result)
            
        print(f"  ç»“æœ: {result}")
        
        if result == expected:
            status = "âœ… é€šè¿‡"
            passed += 1
        else:
            status = "âŒ å¤±è´¥"
            
        print(f"  {status}")
    
    print("\n" + "="*50)
    print(f"æµ‹è¯•ç»“æœ: {passed}/{total} é€šè¿‡ ({passed/total*100:.1f}%)")
    
    return passed == total

def test_raw_llm_output_saving():
    """æµ‹è¯•å¤§æ¨¡å‹åŸå§‹è¾“å‡ºä¿å­˜åŠŸèƒ½"""
    
    print("\n" + "="*50)
    print("æµ‹è¯•å¤§æ¨¡å‹åŸå§‹è¾“å‡ºä¿å­˜åŠŸèƒ½")
    print("="*50)
    
    # åˆ›å»ºæµ‹è¯•æ•°æ®
    test_results = [
        {
            "id": 999,
            "category": "é€‰æ‹©é¢˜",
            "question": "å•†ä¸šé“¶è¡Œæ™®é€šå‘˜å·¥çš„åŸºæœ¬è–ªé…¬é€šå¸¸å æ€»è–ªé…¬çš„æœ€é«˜æ¯”ä¾‹æ˜¯å¤šå°‘ï¼Ÿ",
            "content": "   A. 25%  \n   B. 35%  \n   C. 45%  \n   D. 55%  ",
            "answer": "B",
            "raw_llm_output": "æ ¹æ®å‚è€ƒèµ„æ–™ï¼Œå•†ä¸šé“¶è¡Œçš„åŸºæœ¬è–ªé…¬ä¸€èˆ¬ä¸é«˜äºå…¶è–ªé…¬æ€»é¢çš„35%ã€‚\n\né€‰é¡¹A: 25% - è¿‡ä½ï¼Œå‚è€ƒèµ„æ–™æŒ‡å‡ºåŸºæœ¬è–ªé…¬ä¸€èˆ¬ä¸é«˜äº35%ï¼Œæš—ç¤ºå…¶é€šå¸¸æ¥è¿‘35%ã€‚\né€‰é¡¹B: 35% - æ­£ç¡®ï¼Œä¸å‚è€ƒèµ„æ–™ä¸­æåˆ°çš„æœ€é«˜æ¯”ä¾‹ä¸€è‡´ã€‚\né€‰é¡¹C: 45% - è¿‡é«˜ï¼Œè¶…è¿‡äº†å‚è€ƒèµ„æ–™è§„å®šçš„æœ€é«˜æ¯”ä¾‹35%ã€‚\né€‰é¡¹D: 55% - è¿‡é«˜ï¼Œè¿œè¶…å‚è€ƒèµ„æ–™è§„å®šçš„æœ€é«˜æ¯”ä¾‹35%ã€‚\n\nç­”æ¡ˆï¼šB"
        },
        {
            "id": 998,
            "category": "é—®ç­”é¢˜", 
            "question": "å¦‚æœå¼€æˆ·å•ä½ä¸ä¸­å›½äººæ°‘é“¶è¡Œè´¦åŠ¡ä½™é¢æ ¸å¯¹ä¸ä¸€è‡´ï¼Œåº”å½“é‡‡å–ä»€ä¹ˆæ ‡å‡†åŒ–å¤„ç†æµç¨‹ï¼Ÿ",
            "content": None,
            "answer": "å½“å¼€æˆ·å•ä½ä¸ä¸­å›½äººæ°‘é“¶è¡Œè´¦åŠ¡ä½™é¢æ ¸å¯¹ä¸ä¸€è‡´æ—¶ï¼Œåº”éµå¾ªä»¥ä¸‹æ ‡å‡†åŒ–å¤„ç†æµç¨‹ï¼šé¦–å…ˆï¼Œå¼€æˆ·å•ä½åº”é€ç¬”å‹¾å¯¹å‘ç”Ÿé¢ï¼ŒåŠæ—¶æŸ¥æ¸…åŸå› ï¼Œç”±ä¸»ç®¡ç¡®è®¤å¯¹è´¦ç»“æœï¼Œå¹¶äºˆä»¥è¯´æ˜ã€‚ä¸­å›½äººæ°‘é“¶è¡Œäº‹åç›‘ç£éƒ¨é—¨åº”äºå¼€æˆ·å•ä½å®Œæˆè´¦åŠ¡æ ¸å¯¹çš„å½“æ—¥ç¡®è®¤å¯¹è´¦ç»“æœã€‚è‹¥å¯¹è´¦åŠ¡æ ¸å¯¹ç»“æœæœ‰ç–‘é—®ï¼Œè¥ä¸šéƒ¨é—¨åº”åŠæ—¶ä¸å¼€æˆ·å•ä½è”ç³»ï¼ŒæŸ¥æ¸…åŸå› ï¼Œå¹¶äºˆä»¥è¯´æ˜ï¼›äº‹åç›‘ç£éƒ¨é—¨åº”è¿½è¸ªç›‘ç£ã€‚",
            "raw_llm_output": "å½“å¼€æˆ·å•ä½ä¸ä¸­å›½äººæ°‘é“¶è¡Œè´¦åŠ¡ä½™é¢æ ¸å¯¹ä¸ä¸€è‡´æ—¶ï¼Œåº”éµå¾ªä»¥ä¸‹æ ‡å‡†åŒ–å¤„ç†æµç¨‹ï¼šé¦–å…ˆï¼Œå¼€æˆ·å•ä½åº”é€ç¬”å‹¾å¯¹å‘ç”Ÿé¢ï¼ŒåŠæ—¶æŸ¥æ¸…åŸå› ï¼Œç”±ä¸»ç®¡ç¡®è®¤å¯¹è´¦ç»“æœï¼Œå¹¶äºˆä»¥è¯´æ˜ã€‚ä¸­å›½äººæ°‘é“¶è¡Œäº‹åç›‘ç£éƒ¨é—¨åº”äºå¼€æˆ·å•ä½å®Œæˆè´¦åŠ¡æ ¸å¯¹çš„å½“æ—¥ç¡®è®¤å¯¹è´¦ç»“æœã€‚è‹¥å¯¹è´¦åŠ¡æ ¸å¯¹ç»“æœæœ‰ç–‘é—®ï¼Œè¥ä¸šéƒ¨é—¨åº”åŠæ—¶ä¸å¼€æˆ·å•ä½è”ç³»ï¼ŒæŸ¥æ¸…åŸå› ï¼Œå¹¶äºˆä»¥è¯´æ˜ï¼›äº‹åç›‘ç£éƒ¨é—¨åº”è¿½è¸ªç›‘ç£ã€‚"
        }
    ]
    
    # åˆ›å»ºç³»ç»Ÿå®ä¾‹
    from main import FinancialQASystem
    qa_system = FinancialQASystem()
    
    # æµ‹è¯•ä¿å­˜åŠŸèƒ½
    import time
    timestamp = time.strftime("%Y%m%d_%H%M%S")
    test_output_file = f"test_raw_llm_outputs_{timestamp}.json"
    
    # è°ƒç”¨ä¿å­˜å‡½æ•°
    qa_system.save_raw_llm_outputs(test_results, test_output_file)
    
    # éªŒè¯æ–‡ä»¶æ˜¯å¦ç”Ÿæˆ
    output_path = Path(test_output_file)
    if not output_path.exists():
        print("âŒ æµ‹è¯•å¤±è´¥: è¾“å‡ºæ–‡ä»¶æœªç”Ÿæˆ")
        return False
    
    print("\nâœ… æµ‹è¯•é€šè¿‡: åŸå§‹è¾“å‡ºæ–‡ä»¶å·²ç”Ÿæˆ")
    print(f"  æ–‡ä»¶ä¿å­˜ä½ç½®: {test_output_file}")
    
    return True

if __name__ == "__main__":
    print("ğŸ§ª é€‰æ‹©é¢˜ç­”æ¡ˆæå–æµ‹è¯•")
    
    # æµ‹è¯•ç­”æ¡ˆæå–åŠŸèƒ½
    extract_test_result = test_extract_choice()
    
    # æµ‹è¯•åŸå§‹è¾“å‡ºä¿å­˜åŠŸèƒ½
    raw_output_test_result = test_raw_llm_output_saving()
    
    # æ€»ç»“æµ‹è¯•ç»“æœ
    print("\n" + "="*60)
    print("ğŸ“‹ æµ‹è¯•æ€»ç»“")
    print("="*60)
    print(f"ç­”æ¡ˆæå–åŠŸèƒ½: {'âœ… é€šè¿‡' if extract_test_result else 'âŒ å¤±è´¥'}")
    print(f"åŸå§‹è¾“å‡ºä¿å­˜: {'âœ… é€šè¿‡' if raw_output_test_result else 'âŒ å¤±è´¥'}")
    
    if extract_test_result and raw_output_test_result:
        print("\nğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ç³»ç»ŸåŠŸèƒ½æ­£å¸¸ã€‚")
    else:
        print("\nâš ï¸ éƒ¨åˆ†æµ‹è¯•æœªé€šè¿‡ï¼Œè¯·æ£€æŸ¥é—®é¢˜ã€‚") 