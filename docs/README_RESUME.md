# 断点续跑功能使用说明

## 功能介绍

断点续跑功能允许程序在中断后从上次处理的位置继续运行，无需重新开始整个测试过程。这对于以下场景特别有用：

- 当处理大量题目时程序意外中断
- 需要分多次完成测试任务
- 想检查部分结果后再继续处理剩余部分

## 使用方法

### 交互式选择（新增功能）

现在系统启动时会自动检测是否有中间文件，如果有则提示用户选择是删除这些文件还是进行断点续跑：

```
发现 15 个已有的批次结果文件:
   - batch_results_0_9_20250528_105909.json
   - batch_results_10_19_20250528_105909.json
   - batch_results_20_29_20250528_105909.json
   - ...

请选择操作: 
1. 删除这些文件并重新开始 
2. 保留文件并从断点续跑 
请输入选择(1/2): 
```

只需输入数字选项并按回车即可。这样，即使没有在命令行中指定`--resume`参数，系统也会在运行过程中提供断点续跑的选择。

### 通过start.py启动（推荐）

使用`start.py`脚本启动系统时，可以通过`--resume`参数启用断点续跑：

```bash
python start.py --resume
```

可以同时指定其他参数，如批处理大小、开始索引和结束索引：

```bash
python start.py --resume --batch-size 5 --start-idx 50 --end-idx 100
```

### 直接使用main.py或main_optimized.py

也可以直接使用`main.py`或`main_optimized.py`来启用断点续跑：

```bash
# 标准版
python main.py --resume

# 优化版
python main_optimized.py --resume
```

## 参数说明

| 参数名 | 说明 | 默认值 |
|--------|------|--------|
| `--resume` | 启用断点续跑模式，保留之前的中间结果文件 | 默认不启用 |
| `--batch-size` | 设置每批处理的题目数量 | main.py: 10<br>main_optimized.py: 5 |
| `--start-idx` | 指定开始处理的题目索引 | 0 |
| `--end-idx` | 指定结束处理的题目索引 | 题目总数 |
| `--skip-deps-check` | 跳过依赖检查（仅start.py支持） | 默认不跳过 |

## 工作原理

断点续跑功能的工作原理如下：

1. 启用断点续跑模式后，系统不会删除之前的中间结果文件
2. 系统会扫描outputs目录中的所有批次结果文件
3. 从这些文件中加载已处理的结果
4. 根据文件名中的批次信息，自动确定下一个需要处理的批次
5. 从确定的索引位置继续处理剩余题目
6. 将新处理的结果与之前的结果合并，生成最终输出

## 注意事项

1. 断点续跑模式下，系统会保留所有中间文件，包括批次结果文件和向量数据库
2. 如果您修改了代码或配置，可能需要重新开始测试而不是使用断点续跑
3. 断点续跑功能会自动确定开始索引，即使您手动指定了`--start-idx`参数
4. 为避免ID冲突，系统会根据ID对加载的结果进行排序
5. 当所有批次都已处理完毕时，系统会直接生成最终结果
6. 新增的交互式选择功能仅在检测到中间文件时出现，如果没有中间文件则不会询问

## 示例用法

### 场景1：交互式选择断点续跑

1. 直接运行程序：
```bash
python start.py
```

2. 当系统检测到中间文件时，会提示选择操作：
```
发现15个已有的批次结果文件:
   - batch_results_0_9_20250528_105909.json
   - ...

请选择操作: 
1. 删除这些文件并重新开始 
2. 保留文件并从断点续跑 
```

3. 输入`2`并按回车，系统将自动进入断点续跑模式

### 场景2：处理被中断的测试

假设您正在处理500个题目，程序在处理到第150题时被中断：

```bash
python start.py --resume
```

系统会加载之前处理的150个题目的结果，并从第151题开始继续处理。

### 场景3：分段处理大量题目

如果您想先处理前100个题目，查看结果后再处理剩余部分：

```bash
# 第一次运行，只处理前100个
python start.py --end-idx 100

# 检查结果后，使用断点续跑处理剩余部分
python start.py --resume
```

### 场景4：使用优化版续跑

如果您之前使用优化版处理了部分题目，想继续使用优化版处理剩余部分：

```bash
python main_optimized.py --resume
``` 