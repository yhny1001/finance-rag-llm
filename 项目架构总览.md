# 金融监管制度RAG问答系统 - 项目架构总览

## 📊 项目结构概览

```
项目根目录/
├── 📂 核心运行文件/
│   ├── main.py                    # 🎯 主程序入口
│   ├── rag_engine.py             # 🤖 RAG引擎核心
│   ├── config.py                 # ⚙️ 系统配置文件
│   ├── vector_db.py              # 💾 向量数据库管理
│   └── start.py                  # 🚀 一键启动脚本
│
├── 📂 测试脚本/
│   ├── test_setup.py             # 🔧 环境测试脚本
│   ├── test_imports.py           # 📦 依赖导入测试
│   ├── test_retrieval_quality.py # 🎯 检索质量测试
│   ├── test_result_format.py     # 📋 结果格式测试
│   ├── test_docx_fix.py          # 📄 文档处理测试
│   └── quick_rebuild.py          # ⚡ 快速重建测试
│
├── 📂 优化版本/
│   ├── main_optimized.py         # 🚀 优化版主程序
│   ├── main_improved.py          # ✨ 改进版主程序
│   ├── main_simple.py            # 💡 简化版主程序
│   ├── config_optimized.py       # ⚙️ 优化版配置
│   └── rag_engine_fixed.py       # 🔧 修复版RAG引擎
│
├── 📂 诊断与修复工具/
│   ├── diagnose_system.py        # 🔍 系统诊断工具
│   ├── debug_llm_issue.py        # 🐛 LLM问题调试
│   ├── fix_test_path.py          # 🛠️ 路径修复工具
│   ├── clear_vector_db.py        # 🗑️ 数据库清理工具
│   └── urgent_fix.py             # 🆘 紧急修复脚本
│
├── 📂 数据目录/
│   ├── 📁 赛题制度文档/           # 📄 Word文档存放目录 (100+文档)
│   ├── 📁 数据集A/               # 📊 测试数据集
│   │   └── testA.json           # 测试问题 (1501条)
│   ├── 📁 外汇资料/              # 💱 外汇相关文档
│   ├── 📁 国金资料/              # 🏦 国金相关文档
│   └── 📁 人行资料/              # 🏛️ 人行相关文档
│
├── 📂 输出与数据库/
│   ├── 📁 vector_db/             # 🗄️ 向量数据库存储
│   ├── 📁 output/                # 📤 结果输出目录
│   └── result.json              # 🎯 比赛提交文件
│
└── 📂 依赖与文档/
    ├── requirements.txt          # 📦 项目依赖列表
    ├── README.md                # 📚 项目说明文档
    ├── 快速启动指南_最新版.md    # 🚀 最新启动指南
    ├── 性能优化指南.md           # ⚡ 性能优化说明
    └── 向量数据库技术栈说明.md   # 💾 技术栈文档
```

## 🎯 核心运行文件详解

### 1. 主程序入口 (main.py)
**功能**: 系统主控制器，处理完整的问答流程
```python
# 主要类和方法
class FinancialQASystem:
    - initialize()           # 系统初始化
    - build_knowledge_base() # 构建知识库
    - load_test_data()       # 加载测试数据
    - process_question()     # 处理单个问题
    - process_batch()        # 批量处理
    - save_results()         # 保存结果
```

**启动命令**:
```bash
python main.py              # 标准启动
python main.py --rebuild    # 强制重建索引
```

### 2. RAG引擎核心 (rag_engine.py)
**功能**: 实现RAG架构的核心组件
```python
# 主要类
class DocumentProcessor      # 文档处理器
class SimpleLLM             # 简化LLM接口
class SimpleEmbedding       # 嵌入模型接口
class RAGEngine             # RAG引擎主类

# 核心方法
- load_documents()          # 加载文档
- build_index()             # 构建向量索引
- retrieve_documents()      # 检索相关文档
- generate_answer()         # 生成答案
```

### 3. 系统配置 (config.py)
**功能**: 集中管理所有系统参数
```python
class Config:
    # 模型路径
    LLM_MODEL_PATH = "/mnt/workspace/.cache/modelscope/models/Qwen/Qwen2.5-7B-Instruct"
    EMBEDDING_MODEL_PATH = "/mnt/workspace/.cache/modelscope/models/Jerry0/m3e-base"
    
    # RAG参数
    CHUNK_SIZE = 1000          # 文档切片大小
    TOP_K = 10                 # 检索数量
    TEMPERATURE = 0.1          # 生成温度
```

### 4. 向量数据库 (vector_db.py)
**功能**: 管理FAISS向量数据库的存储和检索
```python
class VectorDatabase:
    - add_documents()          # 添加文档
    - search()                 # 向量检索
    - save()                   # 持久化保存
    - load()                   # 加载数据库
```

### 5. 一键启动脚本 (start.py)
**功能**: 自动检查环境、安装依赖、启动系统
```bash
python start.py             # 一键启动，包含环境检查
```

## 🧪 测试脚本详解

### 1. 环境测试 (test_setup.py)
**用途**: 全面检查项目环境和依赖
```python
# 测试功能
- test_python_version()      # Python版本检查
- test_file_structure()      # 文件结构验证
- test_core_imports()        # 核心模块导入
- test_ml_dependencies()     # ML依赖检查
- test_config_import()       # 配置文件测试
```

**运行方式**:
```bash
python test_setup.py        # 完整环境测试
```

### 2. 导入测试 (test_imports.py)
**用途**: 专门测试各种依赖包的导入情况
```python
# 测试内容
- test_basic_imports()       # 基础包测试
- test_transformers_imports() # AI模型库测试
- test_rag_engine_import()   # RAG引擎测试
```

### 3. 检索质量测试 (test_retrieval_quality.py)
**用途**: 测试RAG系统的检索和回答质量
```python
# 测试场景
- test_key_financial_queries()     # 关键金融查询
- test_specific_question_types()   # 特定问题类型
- test_edge_cases()               # 边界情况测试
```

### 4. 结果格式测试 (test_result_format.py)
**用途**: 验证比赛提交格式的正确性
```python
# 测试功能
- test_choice_answer_extraction()   # 选择题答案提取
- test_competition_format_generation() # 比赛格式生成
```

### 5. 文档处理测试 (test_docx_fix.py)
**用途**: 专门测试Word文档的处理能力
```python
# 测试内容
- test_docx_processing()     # DOCX文件处理
- test_full_document_loading() # 完整文档加载
```

### 6. 快速重建测试 (quick_rebuild.py)
**用途**: 快速重建向量数据库并测试
```python
# 核心功能
- rebuild_vector_db()        # 重建向量数据库
- test_retrieval()          # 测试检索功能
- run_final_test()          # 最终测试
```

## 🚀 运行方式总结

### 方式1: 标准运行流程
```bash
# 1. 环境检查
python test_setup.py

# 2. 清理旧数据（可选）
python clear_vector_db.py clear

# 3. 启动主程序
python main.py
```

### 方式2: 一键启动
```bash
python start.py            # 自动完成所有步骤
```

### 方式3: 使用优化版本
```bash
python main_optimized.py   # 使用性能优化版本
python main_simple.py      # 使用简化版本
```

### 方式4: 快速测试
```bash
python quick_rebuild.py    # 快速重建并测试
```

## 🛠️ 依赖管理

### requirements.txt 核心依赖
```txt
# 深度学习框架
torch>=2.0.0
transformers>=4.30.0
sentence-transformers>=2.2.0

# 向量数据库
faiss-cpu>=1.7.0

# 文档处理
python-docx>=0.8.11
PyPDF2>=3.0.0

# 数据处理
pandas>=1.5.0
numpy>=1.21.0
jieba>=0.42.1
chardet>=5.0.0
tqdm>=4.64.0
```

### 安装命令
```bash
# 一键安装所有依赖
pip install -r requirements.txt

# 或分步安装
pip install torch transformers sentence-transformers
pip install faiss-cpu pandas numpy tqdm
pip install python-docx PyPDF2 jieba chardet
```

## 🔍 系统诊断工具

### 1. 全面系统诊断 (diagnose_system.py)
**功能**: 综合诊断系统健康状态
```bash
python diagnose_system.py  # 全面诊断报告
```

### 2. LLM问题调试 (debug_llm_issue.py)
**功能**: 专门诊断大语言模型相关问题
```bash
python debug_llm_issue.py  # LLM专项调试
```

### 3. 数据库清理 (clear_vector_db.py)
**功能**: 清理向量数据库和缓存
```bash
python clear_vector_db.py clear   # 清除向量数据库
python clear_vector_db.py all     # 清除所有缓存
python clear_vector_db.py status  # 查看状态
```

## 📊 数据文件概览

### 测试数据
- **数据集A/testA.json**: 1501条测试问题（选择题+问答题）
- **金融监管制度问答-测试集.jsonl**: 357KB测试数据

### 知识库文档
- **赛题制度文档/**: 100+个Word文档，涵盖各类金融监管制度
- **外汇资料/**: 外汇管理相关文档
- **国金资料/**: 国金监管相关文档  
- **人行资料/**: 人民银行相关文档

### 输出文件
- **result.json**: 符合比赛要求的提交文件
- **output/**: 详细结果和调试信息
- **vector_db/**: 向量数据库持久化文件

## 🎯 核心技术架构

### RAG (检索增强生成) 架构
1. **文档处理**: 多格式文档解析 (DOCX/PDF/TXT)
2. **文本切片**: 智能分块，保持语义完整性
3. **向量化**: m3e-base模型进行文本嵌入
4. **向量检索**: FAISS高效相似度搜索
5. **答案生成**: Qwen2.5-7B模型生成答案
6. **格式化**: 自动提取和格式化最终答案

### 模型配置
- **LLM**: Qwen2.5-7B-Instruct (7B参数)
- **Embedding**: m3e-base (768维向量)
- **向量数据库**: FAISS IndexFlatIP

### 性能特点
- **多格式支持**: Word、PDF、文本文件
- **智能检索**: Top-K相似度搜索
- **格式适配**: 自动生成比赛要求格式
- **错误恢复**: 完善的异常处理机制

## 🚨 常见问题解决

### 1. 环境问题
```bash
# 检查Python版本
python --version  # 需要3.8+

# 检查依赖
python test_setup.py

# 重新安装依赖
pip install -r requirements.txt
```

### 2. 模型问题
```bash
# 诊断模型加载
python debug_llm_issue.py

# 检查模型路径
python -c "from config import Config; print(Config.LLM_MODEL_PATH)"
```

### 3. 向量数据库问题
```bash
# 清理并重建
python clear_vector_db.py clear
python main.py --rebuild
```

### 4. 文档处理问题
```bash
# 测试文档处理
python test_docx_fix.py

# 检查文档目录
ls -la 赛题制度文档/
```

## 📈 性能优化建议

1. **内存优化**: 调整batch_size和chunk_size
2. **GPU加速**: 确保CUDA环境正确配置
3. **并发控制**: 根据硬件调整max_workers
4. **缓存利用**: 保留向量数据库避免重复构建

这个架构文档为您提供了项目的完整概览，包括所有核心文件、测试脚本、运行方式和故障排除方法。 