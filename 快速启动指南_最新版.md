# 金融监管制度RAG问答系统 - 快速启动指南 (最新版)

## 📋 系统概述

本系统是一个基于RAG(检索增强生成)架构的金融监管制度问答系统，支持处理Word文档(.docx)、PDF、文本文件等多种格式，使用Qwen2.5-7B大语言模型和m3e-base嵌入模型。

**✨ 新功能：自动生成符合比赛要求的`result.json`文件！**

## 🔧 环境要求

- **硬件**: 8核CPU，32GB内存，24GB GPU显存
- **Python**: 3.8+
- **CUDA**: 支持GPU加速(可选)

## 📦 依赖安装

### 1. 安装核心依赖
```bash
pip install torch transformers sentence-transformers
pip install faiss-cpu pandas numpy tqdm jieba chardet
```

### 2. 安装文档处理依赖
```bash
pip install python-docx PyPDF2
```

### 3. 或一键安装所有依赖
```bash
pip install -r requirements.txt
```

## 📁 项目结构

```
项目根目录/
├── 赛题制度文档/           # Word文档(.docx)存放目录
├── 数据集A/               # 测试数据集
│   └── testA.json        # 测试问题(JSONL格式)
├── vector_db/            # 向量数据库存储目录
├── main.py              # 主程序入口
├── rag_engine.py        # RAG引擎核心(已修复DOCX支持)
├── config.py            # 配置文件
├── vector_db.py         # 向量数据库管理
├── clear_vector_db.py   # 数据库清理工具
├── test_result_format.py # 比赛格式测试工具
├── result.json          # 比赛提交文件(自动生成)
└── requirements.txt     # 依赖列表
```

## 🚀 快速启动

### 方法1: 直接运行主程序
```bash
python main.py
```

### 方法2: 清除旧索引后运行
```bash
# 清除向量数据库(如果之前有乱码问题)
python clear_vector_db.py clear

# 重新运行程序
python main.py
```

## 🎯 新增功能：比赛格式输出

现在系统会**自动生成**符合比赛要求的`result.json`文件！

### 输出格式示例
```json
{"id":12,"answer":["B"]}
{"id":13,"answer":"商业银行的资本充足率最低要求包括：核心一级资本充足率不低于5%，一级资本充足率不低于6%，总资本充足率不低于8%。"}
```

### 格式说明
- **选择题**: `{"id": 问题ID, "answer": ["选项"]}`
- **问答题**: `{"id": 问题ID, "answer": "详细答案文本"}`
- **文件格式**: JSONL (每行一个JSON对象)
- **文件名**: `result.json` (项目根目录)

### 测试新格式
```bash
# 测试比赛格式生成功能
python test_result_format.py
```

## 🛠️ 数据库管理操作

### 清除向量数据库切片
```bash
# 只清除向量数据库，强制重新构建索引
python clear_vector_db.py clear

# 清除向量数据库和所有缓存文件
python clear_vector_db.py all

# 只清除Python缓存文件
python clear_vector_db.py cache

# 查看当前状态
python clear_vector_db.py status
```

### 手动删除数据库文件
如果脚本无法删除，可以手动删除以下文件/目录：
- `vector_db/` 目录
- `faiss_index.bin` 文件
- `vector_metadata.json` 文件
- `document_store.json` 文件

## 🔍 系统功能

### 1. 文档处理能力
- ✅ **Word文档(.docx)**: 自动提取段落和表格文本
- ✅ **PDF文档**: 提取文本内容
- ✅ **文本文件(.txt, .md)**: 自动编码检测
- ✅ **多编码支持**: UTF-8, GBK, GB2312等

### 2. 问答功能
- **选择题**: 分析题目选项，给出答案和理由
- **问答题**: 基于文档内容提供详细答案
- **上下文检索**: 自动查找最相关的监管文档

### 3. 向量检索
- **FAISS索引**: 高效向量相似度搜索
- **持久化存储**: 自动保存和加载向量数据库
- **增量更新**: 支持添加新文档

### 4. 智能答案处理
- **选择题答案提取**: 自动从LLM回答中提取A/B/C/D选项
- **格式规范化**: 确保输出符合比赛要求
- **错误处理**: 提供默认答案和错误恢复

## 📊 运行流程

1. **初始化检查**
   - 检查文档目录: `赛题制度文档/`
   - 验证测试数据: `数据集A/testA.json`
   - 加载配置和模型

2. **文档处理** (首次运行或清除数据库后)
   - 扫描并加载所有.docx文档
   - 提取文本内容(不再是乱码!)
   - 文档切片和向量化
   - 构建FAISS索引

3. **问答处理**
   - 读取测试问题
   - 向量检索相关文档
   - LLM生成答案
   - 智能答案格式化

4. **结果输出**
   - 生成完整结果文件(调试用)
   - **自动生成`result.json`(比赛提交用)**
   - 保存CSV格式(便于查看)
   - 验证输出格式

## 🧪 测试验证

### 测试DOCX文档处理
```bash
python test_docx_fix.py
```

### 测试比赛格式输出
```bash
python test_result_format.py
```

### 验证系统状态
```bash
python clear_vector_db.py status
```

## ⚠️ 常见问题

### Q1: 看到乱码怎么办？
```bash
# 清除旧的向量数据库
python clear_vector_db.py clear
# 重新运行，现在会正确提取DOCX文本
python main.py
```

### Q2: result.json格式不对？
```bash
# 测试格式生成功能
python test_result_format.py
# 检查选择题答案提取是否正常
```

### Q3: 内存不足怎么办？
- 修改`config.py`中的`CHUNK_SIZE`减小切片大小
- 使用CPU模式: 设置`device_map="cpu"`

### Q4: 模型加载失败？
```bash
# 检查transformers版本兼容性
pip install transformers==4.44.0
```

### Q5: JSON解析错误？
- 确认`testA.json`是JSONL格式(每行一个JSON对象)
- 检查文件编码是否为UTF-8

## 📝 配置说明

主要配置项(`config.py`):
```python
DOCUMENT_DIR = "赛题制度文档"           # 文档目录
TEST_DATA_PATH = "数据集A/testA.json"   # 测试数据路径
LLM_MODEL_PATH = "Qwen/Qwen2.5-7B-Instruct"
EMBEDDING_MODEL_PATH = "moka-ai/m3e-base"
CHUNK_SIZE = 1000                      # 文档切片大小
TOP_K_RETRIEVAL = 5                    # 检索文档数量
```

## 🎯 预期输出

### 完整结果文件 (results_*.json)
```json
{
  "id": "问题ID",
  "category": "选择题/问答题",
  "question": "原始问题",
  "answer": "生成的答案",
  "context_used": "使用的上下文",
  "num_sources": 3,
  "timestamp": "2024-01-01 10:00:00"
}
```

### 比赛提交文件 (result.json)
```json
{"id":12,"answer":["B"]}
{"id":13,"answer":"详细的问答题答案"}
```

## 📈 性能优化建议

1. **首次运行**: 文档处理和索引构建需要5-10分钟
2. **后续运行**: 加载已有索引，启动时间约1-2分钟
3. **GPU加速**: 如有GPU可显著提升推理速度
4. **内存管理**: 监控显存使用，必要时调整批处理大小

## 🔄 版本更新记录

### v3.0 (最新版) - 比赛格式输出版
- ✅ **自动生成比赛要求的result.json文件**
- ✅ **智能选择题答案提取**(A/B/C/D)
- ✅ **JSONL格式输出**(每行一个JSON对象)
- ✅ **格式验证和测试工具**
- ✅ 完善的错误处理和默认答案

### v2.0 - DOCX修复版
- ✅ 修复Word文档(.docx)乱码问题
- ✅ 增强文档处理能力
- ✅ 添加数据库管理工具
- ✅ 优化错误处理和日志输出
- ✅ 完善测试和验证脚本

### v1.0 - 基础版
- 基本RAG功能
- FAISS向量检索
- JSON数据处理

---

🎉 **现在系统完全符合比赛要求，能够自动生成正确格式的`result.json`文件！直接运行即可获得可提交的结果文件。** 