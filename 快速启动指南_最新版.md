# 金融监管制度RAG问答系统 - 快速启动指南 (最新版)

## 📋 系统概述

本系统是一个基于RAG(检索增强生成)架构的金融监管制度问答系统，支持处理Word文档(.docx)、PDF、文本文件等多种格式，使用Qwen2.5-7B大语言模型和m3e-base嵌入模型。

## 🔧 环境要求

- **硬件**: 8核CPU，32GB内存，24GB GPU显存
- **Python**: 3.8+
- **CUDA**: 支持GPU加速(可选)

## 📦 依赖安装

### 1. 安装核心依赖
```bash
pip install torch transformers sentence-transformers
pip install faiss-cpu pandas numpy tqdm jieba chardet
```

### 2. 安装文档处理依赖
```bash
pip install python-docx PyPDF2
```

### 3. 或一键安装所有依赖
```bash
pip install -r requirements.txt
```

## 📁 项目结构

```
项目根目录/
├── 赛题制度文档/           # Word文档(.docx)存放目录
├── 数据集A/               # 测试数据集
│   └── testA.json        # 测试问题(JSONL格式)
├── vector_db/            # 向量数据库存储目录
├── main.py              # 主程序入口
├── rag_engine.py        # RAG引擎核心(已修复DOCX支持)
├── config.py            # 配置文件
├── vector_db.py         # 向量数据库管理
├── clear_vector_db.py   # 数据库清理工具
└── requirements.txt     # 依赖列表
```

## 🚀 快速启动

### 方法1: 直接运行主程序
```bash
python main.py
```

### 方法2: 清除旧索引后运行
```bash
# 清除向量数据库(如果之前有乱码问题)
python clear_vector_db.py clear

# 重新运行程序
python main.py
```

## 🛠️ 数据库管理操作

### 清除向量数据库切片
```bash
# 只清除向量数据库，强制重新构建索引
python clear_vector_db.py clear

# 清除向量数据库和所有缓存文件
python clear_vector_db.py all

# 只清除Python缓存文件
python clear_vector_db.py cache

# 查看当前状态
python clear_vector_db.py status
```

### 手动删除数据库文件
如果脚本无法删除，可以手动删除以下文件/目录：
- `vector_db/` 目录
- `faiss_index.bin` 文件
- `vector_metadata.json` 文件
- `document_store.json` 文件

## 🔍 系统功能

### 1. 文档处理能力
- ✅ **Word文档(.docx)**: 自动提取段落和表格文本
- ✅ **PDF文档**: 提取文本内容
- ✅ **文本文件(.txt, .md)**: 自动编码检测
- ✅ **多编码支持**: UTF-8, GBK, GB2312等

### 2. 问答功能
- **选择题**: 分析题目选项，给出答案和理由
- **问答题**: 基于文档内容提供详细答案
- **上下文检索**: 自动查找最相关的监管文档

### 3. 向量检索
- **FAISS索引**: 高效向量相似度搜索
- **持久化存储**: 自动保存和加载向量数据库
- **增量更新**: 支持添加新文档

## 📊 运行流程

1. **初始化检查**
   - 检查文档目录: `赛题制度文档/`
   - 验证测试数据: `数据集A/testA.json`
   - 加载配置和模型

2. **文档处理** (首次运行或清除数据库后)
   - 扫描并加载所有.docx文档
   - 提取文本内容(不再是乱码!)
   - 文档切片和向量化
   - 构建FAISS索引

3. **问答处理**
   - 读取测试问题
   - 向量检索相关文档
   - LLM生成答案
   - 输出结构化结果

## 🧪 测试验证

### 测试DOCX文档处理
```bash
python test_docx_fix.py
```

### 验证系统状态
```bash
python clear_vector_db.py status
```

## ⚠️ 常见问题

### Q1: 看到乱码怎么办？
```bash
# 清除旧的向量数据库
python clear_vector_db.py clear
# 重新运行，现在会正确提取DOCX文本
python main.py
```

### Q2: 内存不足怎么办？
- 修改`config.py`中的`CHUNK_SIZE`减小切片大小
- 使用CPU模式: 设置`device_map="cpu"`

### Q3: 模型加载失败？
```bash
# 检查transformers版本兼容性
pip install transformers==4.44.0
```

### Q4: JSON解析错误？
- 确认`testA.json`是JSONL格式(每行一个JSON对象)
- 检查文件编码是否为UTF-8

## 📝 配置说明

主要配置项(`config.py`):
```python
DOCUMENT_DIR = "赛题制度文档"           # 文档目录
TEST_DATA_PATH = "数据集A/testA.json"   # 测试数据路径
LLM_MODEL_PATH = "Qwen/Qwen2.5-7B-Instruct"
EMBEDDING_MODEL_PATH = "moka-ai/m3e-base"
CHUNK_SIZE = 1000                      # 文档切片大小
TOP_K_RETRIEVAL = 5                    # 检索文档数量
```

## 🎯 预期输出

```json
{
  "id": "问题ID",
  "question": "原始问题",
  "answer": "生成的答案",
  "confidence": 0.85,
  "retrieved_docs": 3,
  "context_preview": "检索到的文档预览..."
}
```

## 📈 性能优化建议

1. **首次运行**: 文档处理和索引构建需要5-10分钟
2. **后续运行**: 加载已有索引，启动时间约1-2分钟
3. **GPU加速**: 如有GPU可显著提升推理速度
4. **内存管理**: 监控显存使用，必要时调整批处理大小

## 🔄 版本更新记录

### v2.0 (最新版) - DOCX修复版
- ✅ 修复Word文档(.docx)乱码问题
- ✅ 增强文档处理能力
- ✅ 添加数据库管理工具
- ✅ 优化错误处理和日志输出
- ✅ 完善测试和验证脚本

### v1.0 - 基础版
- 基本RAG功能
- FAISS向量检索
- JSON数据处理

---

🎉 **现在系统已经完全修复，可以正确处理Word文档并生成有意义的答案！** 